{% extends 'home/base.html' %}
{% load static %}

{% block content %}


<section class="section-content padding-y bg">
    <div class="container">
    
    <!-- ============================ COMPONENT 1 ================================= -->
    <div class="row">
        <aside class="col-lg-8">
    
        <div class="card">
            <h5 class="card-header">Billing Address</h5>
            <div class="card-body">
              
              <p class="card-text mb-0"><strong>Name:</strong> {{ order.full_name }}</p>
              <p class="cart-text mb-0"><strong>Address:</strong>{{ order.full_address }}</p>
              <p class="cart-text mb-0">{{ order.city}}</p>
              <p class="cart-text mb-0">{{ order.state}}</p>
              <p class="cart-text mb-0"><strong>Email:</strong> {{ order.email}}</p>
              <p class="cart-text mb-0"><strong>Phone:</strong> {{ order.phone}}</p>
              
            </div>
          </div>
          <div class="card mt-3">
            <div class="card-body">
              <h5 class="card-title">Payment Method</h5>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="flexRadioDefault" id="flexRadioDefault1">
                <label class="form-check-label" for="flexRadioDefault1">
                   paypal
                </label>
                <div id="paypal-button-container"></div>

                <!-- Include the PayPal JavaScript SDK -->
               
                
              </div>
              
              <div class="form-check mt-3">
                <button type="button" class="btn btn-primary paywithRazorpay w-100 mt-2"></button>


               


              </div>
             
              <div class="form-check mt-3">
                <input class="form-check-input" type="radio" name="flexRadioDefault" id="flexRadioDefault1">
                <label class="form-check-label" for="flexRadioDefault1" id="cod">
                    Cash on Delivery
                </label>
              </div>
              <div>
                <form action="{% url 'payments' %}" >

                  <input type="hidden" value="razorpay" name="payment_method">
                  <input type="hidden" value="completed" name="status">
                  <input type="hidden" name="transID">
                  <input type="hidden" name="orderID" value="{{order.order_number}}">
                  <input type="text" hidden value="{{ coupon }}" name="coupon">

                  <script
                      src="https://checkout.razorpay.com/v1/checkout.js"
                      data-key="rzp_test_ftUDx8pmsTCDs8" // Enter the Test API Key ID generated from Dashboard → Settings → API Keys
                      data-amount="29935" // Amount is in currency subunits. Hence, 29935 refers to 29935 paise or ₹299.35.
                      data-currency="INR"// You can accept international payments by changing the currency code. Contact our Support Team to enable International for your account
                      data-order_id="{{payment}}"// Replace with the order_id generated by you in the backend.
                      data-buttontext="Pay with Razorpay"
                      data-name="Acme Corp"
                      data-description="A Wild Sheep Chase is the third novel by Japanese author Haruki Murakami"
                      data-image="https://example.com/your_logo.jpg"
                      data-prefill.name="Gaurav Kumar"
                      data-prefill.email="gaurav.kumar@example.com"
                      data-theme.color="#F37254"
                  ></script>
                  <input type="hidden" custom="Hidden Element" name="hidden">
                  </form>
              </div>
              <!-- <a href="#" class="btn btn-primary">Go somewhere</a> --> 
            </div>
          </div>
          <div class="card mt-3">
            <div class="card-body">
              <h5 class="card-title">Product Review</h5>
              <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
              <a href="#" class="btn btn-primary">Go somewhere</a>
            </div>
          </div>
     <!-- card.// -->
    
        </aside> <!-- col.// -->
        <aside class="col-lg-4">
    
            <div class="card">
            <div class="card-body">
                <dl class="dlist-align">
                  <dt>Total price:</dt>
                  <dd class="text-right">{{ total }}</dd>
                </dl>
                
                <dl class="dlist-align">
                  <dt>Grand Total:</dt>
                  <dd class="text-right text-dark b"><strong>${{ grand_total }}</strong></dd>
                </dl>
                <hr>
                <p class="text-center mb-3">
                    <img src="{% static 'user/images/misc/payments.png' %}" height="26">
                </p>
                <a href="{% url 'checkout' %}" class="btn btn-primary btn-block"> Make payment </a>
    
            </div> <!-- card-body.// -->
            </div> <!-- card.// -->
    
    </aside> <!-- col.// -->
    
    
    </div> <!-- row.// -->
    <!-- ============================ COMPONENT 1 END .// ================================= -->
    </div> <!-- container .//  -->
</section>

<script>
  function getCookie(name) {

    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

 
var amount = "{{ grand_total }}"
var url = "{% url 'payments' %}"
var csrftoken = getCookie('csrftoken');
var orderID = "{{order.order_number}}"
var payment_method = 'PayPal'
var redirect_url = "{% url 'order_complete' %}"
  // Render the PayPal button into #paypal-button-container
  
  paypal.Buttons({

      style: {
        color: 'blue',
        shape: 'rect',
        label: 'pay',
        height: 40
      },
      // Set up the transaction

      createOrder: function(data, actions) {
        return actions.order.create({
          purchase_units: [{
            amount: {
              value: amount,
            }
          }]
        });
      },
      // Finalize the transaction
      onApprove: function(data, actions) {
        return actions.order.capture().then(function(details) {
          // Show a success message to the buyer
          console.log(details);
          sendData();
          function sendData(){
            fetch(url, {
              method : "POST",
              headers: {
                "Content-type": "application/json",
                "X-CSRFToken": csrftoken,
              },
              body: JSON.stringify({
                orderID: orderID,
                transID: details.id,
                payment_method: payment_method,
                status: details.status,
                coupon:"{{ coupon }}"
              }),
            })
            .then((response) => response.json())
            .then((data) => {
              window.location.href = redirect_url + '?order_number='+data.order_number+'&payment_id='+data.transID;
            });
          }
        });
      }
  
    }).render('#paypal-button-container');
</script>

<script>
  document.getElementById('cod').addEventListener('click',function(){

    alert(orderID)

    
    fetch(url, {
      method : "POST",
      headers: {
        "Content-type": "application/json",
        "X-CSRFToken": csrftoken,
      },
      body: JSON.stringify({
        orderID: orderID,
        transID: '',
        payment_method: 'cash on delivery',
        status: 'pending',
        coupon:'{{coupon}}'
      }),
    })
    .then((response) => response.json())
    .then((data) => {
      window.location.href = redirect_url + '?order_number='+data.order_number+'&payment_id='+data.transID;
    });
  })
</script>


{% endblock content %}
{% block scripts %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
{% endblock scripts %}